C251 COMPILER V5.60.0,  CONTROL_SYSTEM                                                     18/03/22  21:56:56  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE CONTROL_SYSTEM
OBJECT MODULE PLACED IN .\Objects\CONTROL_SYSTEM.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE CODE\USER\CONTROL_SYSTEM.c LARGE INTR2 BROWSE INCDIR(.\CODE\ALGORITHM;
                    -.\CODE\DRIVER;.\CODE\Libraries\libraries;.\CODE\Libraries\seekfree_libraries;.\CODE\Libraries\seekfree_peripheral;.\CODE
                    -\USER) DEBUG PRINT(.\Listings\CONTROL_SYSTEM.lst) TABS(2) OBJECT(.\Objects\CONTROL_SYSTEM.obj) 

stmt  level    source

    1          #include "CONTROL_SYSTEM.h"
    2          #include "SERVO_MOTOR_CONTROL.h"
    3          #include "STEP_MOTOR_CONTROL.h"
    4          #include "EM_SENSOR.h"
    5          #include "ENCODE_SENSOR.h"
    6          #include "LCD_show.h"
    7          #include "headfile.h"
    8          #include "common.h"
    9          #include "EM_Calc.h"
   10          
   11          CAR_STATUS CUR_STATUS;  //ÂΩìÂâçÁä∂ÊÄÅ
   12          
   13          int DATA[4];  //ÁîµÁ£Å‰º†ÊÑüÂô®Êï∞ÊçÆÂ≠òÂÇ®ÂàóË°®
   14          int RES;
   15          float backup;//Â∑¶Âè≥ÁîµÊÑüÂ∑ÆÂÄº
   16          void (*func[8])();//ÂáΩÊï∞ÊåáÈíàÊï∞ÁªÑÔºåÁî®‰∫éÊò†Â∞Ñ‰∏çÂêåÁä∂ÊÄÅÂØπÂ∫îÁöÑÂáΩÊï∞
   17          int SC_flag;//‰∏âÂèâË∑ØÂè£Ê†áÂøó‰Ωç
   18          int flag;
   19          int TARGET_SPEED;
   20          float ANGLE;
   21          int b,h,s,SPO;
   22          CAR_STATUS CAR_STATUS_JUDGE() {//Áä∂ÊÄÅÂà§Êñ≠
   23   1      //    int huan_dw;//ÁéØÂ≤õÊ†áÂøó‰Ωç
   24   1      //  if(huan_dw==0&&DATA[0]>1400&&(DATA[3]>1400||DATA[1]>2000)&&DATA[0]>DATA[3]) {//Âè≥ÁéØÂÖ•
   25   1      //    SteeringControl(40);
   26   1      //    h++;
   27   1      //  }
   28   1      //  if(huan_dw==1&&DATA[0]>1400&&(DATA[3]>1400||DATA[1]>2000)&&DATA[0]>DATA[3])//Âè≥ÁéØÂá∫
   29   1      //    SteeringControl(0);
   30   1      //  
   31   1      //  
   32   1      
   33   1      //        /******‰∏âÂèâÂà§Êñ≠********/
   34   1      //  if(flag==0&&DATA[2]+DATA[1]<1700&&DATA[0]>450&&DATA[3]>450&&DATA[0]<1400&&DATA[3]<1400){//‰∏âÂèâÂè≥Êâì
             -Ëßí
   35   1      //   SteeringControl(-40);
   36   1      //   s++ ;
   37   1      //  }//s==12
   38   1      //  if(flag==1&&DATA[2]+DATA[1]<1700&&DATA[0]>450&&DATA[3]>450&&DATA[0]<1400&&DATA[3]<1400)//‰∏âÂèâÂ∑¶ÊâìË
             -Ñö
   39   1      //    SteeringControl(40);
   40   1      
   41   1      //         /*****Âá∫ÁéØ„ÄÅÂá∫‰∏âÂèâÂà§Êñ≠********/
   42   1      //    if(s>1&&DATA[0]>1400)flag=1;
   43   1        /*‰∏âÂèâÂ§ÑÁêÜ*/
   44   1      //  if(DATA[1]<500&&DATA[2]<500&&DATA[0]<600&&DATA[3]<600&&SC_flag==0&&flag==0){//ÂÖ•Â∑¶‰∏âÂèâ
   45   1      //        SC_flag=1;
   46   1      //        SteeringControl(-40);
   47   1      //        return ON_JUNCTION;
   48   1      //  }
   49   1      //  if(DATA[1]>1000||DATA[2]>1000&&SC_flag==1&&flag==0){//Âá∫Â∑¶‰∏âÂèâ
   50   1      //    flag=1;//Â∑≤ÁªèËøõÂÖ•‰∏ÄÊ¨° 
   51   1      //        SteeringControl(-40); 
   52   1      //    SC_flag=0;
   53   1      //        return ON_JUNCTION;
   54   1      //  } 
   55   1      //    if(DATA[1]<500&&DATA[2]<500&&DATA[0]<600&&DATA[3]<600&&SC_flag==0&&flag==1){//ÂÖ•Âè≥‰∏âÂèâ
C251 COMPILER V5.60.0,  CONTROL_SYSTEM                                                     18/03/22  21:56:56  PAGE 2   

   56   1      //    SC_flag=1;
   57   1      //        SteeringControl(40);
   58   1      //        return ON_JUNCTION;
   59   1      //  }
   60   1      //  if(DATA[1]>1000||DATA[2]>1000&&SC_flag==1&&flag==1){//Âá∫Âè≥‰∏âÂèâ
   61   1      //    flag=0;//ÂÖ•‰∏âÂèâÊ†áÂøó‰ΩçÊ∏ÖÈõ∂
   62   1      //        SteeringControl(40);
   63   1      //    SC_flag=0;
   64   1      //        return ON_JUNCTION;
   65   1      //  } 
   66   1      //   /*ÂçÅÂ≠óË∑ØÂè£Â§ÑÁêÜ*/
   67   1      //  if(DATA[0]>1000&&DATA[3]>1000&&DATA[1]>1000||DATA[2]>1000){
   68   1      //    return ON_CROSS;
   69   1      //  }
   70   1      //     /* * * ÁéØÂ≤õÂ§ÑÁêÜ * * */ 
   71   1      //  if(DATA[1]>2000&&DATA[2]>2000&&DATA[3]>DATA[0]&&huan_dw==0) {//ÁéØÊ†áÂøó
   72   1      //    huan_dw++;
   73   1      //        return INTO_CIRCLE;
   74   1      //   }
   75   1      //   if(DATA[1]>2000&&DATA[2]>2000&&DATA[3]>DATA[0]&&huan_dw==1) {//ÁéØÊ†áÂøó
   76   1      //    huan_dw++;
   77   1      //        return OUT_CIRCLE;
   78   1      //   }
   79   1      //   else{//Èò≤Ê≠¢ÂÜçÊ¨°ÂÖ•ÁéØ
   80   1            //  return STRAIGHT;
   81   1      //   }
   82   1         
   83   1      //    if((DATA[0]>90&&DATA[1]>90&&DATA[1]>=65&&
   84   1      //      DATA[1]<=70&&DATA[0]>=65&&DATA[0]<=70)   
   85   1      //      ||(DATA[0]>90&&DATA[1]>90&&DATA[1]>=65&&
   86   1      //      DATA[1]<=70&&DATA[0]>=65&&DATA[0]<70)) {//ÁéØÊ†áÂøó
   87   1      //      if(huan_dw==0) return INTO_CIRCLE;
   88   1      //      else {//Èò≤Ê≠¢ÂÜçÊ¨°ÂÖ•ÁéØ
   89   1      //          huan_dw=0;
   90   1      //        }
   91   1      //    }
   92   1      
   93   1          //ÂàÜÊÆµPD
   94   1      //  if (DATA[0]<80&&DATA[3]<80)
   95   1      //    {
   96   1      //    SteeringPID_State(2);
   97   1      //      return INTO_CURVE;/* code */
   98   1      //    }
   99   1      // if(backup<=300&&a==0){
  100   1      //    return STRAIGHT;
  101   1      //  }
  102   1      // /* * * ÂºØÈÅìÂ§ÑÁêÜ * * */
  103   1      // if(300<backup&&backup<=600&&a==0){
  104   1      //     SteeringPID_State(1);
  105   1      //     return INTO_CURVE;
  106   1      // }   
  107   1      //   if(backup>250){
  108   1      //        SteeringPID_State(2);
  109   1      //        return ON_CURVE;
  110   1      //   } 
  111   1      //   if(backup>600||a<=1){
  112   1      //         a++;
  113   1      //    if(a>1) a=0;
  114   1      //         SteeringPID_State(2);
  115   1      //         return ON_CURVE;
  116   1      //    } 
  117   1      }
  118          
  119          void SYS_INIT_ALL(){
  120   1          sys_clk=30000000;//Êó∂ÈíüÈ¢ëÁéá
  121   1          board_init();//Âõ∫‰ª∂ÂàùÂßãÂåñ
C251 COMPILER V5.60.0,  CONTROL_SYSTEM                                                     18/03/22  21:56:56  PAGE 3   

  122   1          lcd_init();//ÊòæÁ§∫Â±èÂàùÂßãÂåñ
  123   1          ISR_INIT();
  124   1          EnableGlobalIRQ();//‰∏≠Êñ≠ÂàùÂßãÂåñ
  125   1      }
  126          
  127          void CONTROL_SYS_INIT(){
  128   1          //Áä∂ÊÄÅÂáΩÊï∞ÂàóË°®ÂàùÂßãÂåñ
  129   1          func[0] = FUNC_STRAIGHT;
  130   1          func[1] = FUNC_INTO_CURVE;
  131   1          func[2] = FUNC_ON_CURVE;
  132   1          func[3] = FUNC_OUT_CURVE;
  133   1          func[4] = FUNC_INTO_CIRCLE;
  134   1          func[5] = FUNC_CROSS;
  135   1          func[6] = FUNC_OUT_CIRCLE;
  136   1          func[7] = FUNC_JUNCTION;
  137   1          EM_INIT();//ÁîµÁ£Å‰º†ÊÑüÂô®ÂàùÂßãÂåñ
  138   1          ENCODING_INIT();//ÁºñÁ†ÅÂô®ÂàùÂßãÂåñ
  139   1          StepMotorControl_INIT();//Ê≠•ËøõÁîµÊú∫ÊéßÂà∂Á≥ªÁªüÂàùÂßãÂåñ
  140   1          SteeringControl_INIT();//ËàµÊú∫ÊéßÂà∂Á≥ªÁªüÂàùÂßãÂåñ
  141   1          lcd_clear(BLUE);
  142   1          lcd_clear(WHITE);//lcdÂà∑Êñ∞
  143   1          SC_flag=0;//‰∏âÂèâË∑ØÂè£Ê†áÂøó‰Ωç
  144   1          flag=0;
  145   1          SPO=0;
  146   1          b=0;
  147   1      }
  148          
  149          void Data_update(){
  150   1          int ERROR;
  151   1          EM_READ(DATA);//ËØªÂèñÊï∞ÊçÆ
  152   1          ERROR = EM_CALC_POS_RES(DATA)*1000;
  153   1          LCD("R",DATA[0],0);//ÊòæÁ§∫ÁîµÊÑüÂÄº
  154   1          LCD("RM",DATA[1],1);
  155   1          LCD("LM",DATA[2],2);
  156   1          LCD("L",DATA[3],3);
  157   1          //LCD("SPEED",RES,4);//ÊòæÁ§∫ÁºñÁ†ÅÂô®ËØªÂèñÊï∞ÊçÆ
  158   1          //LCD("ANGLE",ANGLE,5);//ÊòæÁ§∫ËßíÂ∫¶
  159   1          LCD("D",ERROR,4);//ÊòæÁ§∫ËØØÂ∑Æ
  160   1          RES = ENCODING_READ_RESULT();//ÁºñÁ†ÅÂô®ËØªÂèñÁîµÊú∫ËΩ¨ÈÄü
  161   1          backup=(DATA[1]-DATA[2]>0 ? DATA[1]-DATA[2] : DATA[2]-DATA[1]);
  162   1      }
  163          
  164          void ControlSys() {
  165   1         //CUR_STATUS = CAR_STATUS_JUDGE();
  166   1        // LCD("STATU",CUR_STATUS,8);
  167   1         //(*func[CUR_STATUS])();
  168   1        FORWARD_FUNC(0,0);
  169   1          
  170   1      }
  171          
  172          //ÂâçËøõÂáΩÊï∞
  173          void FORWARD_FUNC(float USERANGLE,int SPEED){   
  174   1          float Kp;  
  175   1          Kp = (backup/((DATA[1]+DATA[2]+DATA[0]+DATA[3])*0.53))*130;//60
  176   1          //LCD("Kp",Kp,5);//ÊòæÁ§∫ËßíÂ∫¶
  177   1          ANGLE = ANGLE_GETANGLE(DATA,USERANGLE,Kp,0,70);//‰ΩçÁΩÆÂºèPIDKp = (backup/(DATA[1]+DATA[2]))*50;
  178   1          if(DATA[0]<10&&DATA[3]>300) ANGLE=40;
  179   1          if(DATA[3]<10&&DATA[0]>300) ANGLE=-40;
  180   1         //60ANGLE = ANGLE_GETANGLE(DATA,USERANGLE,Kp,34,25);//‰ΩçÁΩÆÂºèPID
  181   1          LCD("ANGLE",ANGLE,8);//ÊòæÁ§∫ËßíÂ∫¶ 
  182   1          if (SPEED == 0) TARGET_SPEED = (400-(int)(backup*0.16));
  183   1          else  TARGET_SPEED=SPEED;  //ÂºØÈÅìÊúÄ‰Ωé+Áõ¥ÈÅìÂä†ÈÄü0.013
  184   1          b=(b>RES ? b : RES);
  185   1          LCD("TS",RES,5);
  186   1          if(RES > 2000)  TARGET_SPEED=0;//‰∏ãÂù°ÈôêÈÄü 
  187   1          if(DATA[1]<10) TARGET_SPEED=-1000; 
C251 COMPILER V5.60.0,  CONTROL_SYSTEM                                                     18/03/22  21:56:56  PAGE 4   

  188   1          //if(DATA[1]+DATA[2]>1800&&DATA[1]+DATA[2]<2000&&DATA[1]<1100&&DATA[2]<1100&&DATA[0]+DATA[3]>500)  SPO=
             -1;
  189   1          //LCD("SP",SPO,8);  
  190   1        //TARGET_SPEED=SPEED; //min_SPEED + (max_SPEED - min_SPEED)/10*ANGLE;
  191   1          //Âà©Áî®ËàµÊú∫ÊâìËßíËßíÂ∫¶ÔºåÂ§ÑÁêÜÂá∫ÈÄüÂ∫¶ÁõÆÊ†áÂÄº
  192   1          StepMotorControl(RES,TARGET_SPEED);//ÁîµÊú∫ËæìÂá∫
  193   1          SteeringControl(-ANGLE);
  194   1      }
  195          
  196          //Áõ¥Á∫øË°åÈ©∂Áä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  197          void FUNC_STRAIGHT() {
  198   1          //SteeringPID_State(ON_STRAIGHT);
  199   1          FORWARD_FUNC(0,0);
  200   1      }
  201          
  202          //ÂÖ•ÂºØÁä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  203          void FUNC_INTO_CURVE(){
  204   1          //SteeringPID_State(ON_TURN);
  205   1          FORWARD_FUNC(0,0);
  206   1          CUR_STATUS = ON_CURVE;
  207   1      }
  208          
  209          //Âú®ÂºØÈÅì‰∏≠Áä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  210          void FUNC_ON_CURVE(){
  211   1          FORWARD_FUNC(0,0);
  212   1      }
  213          
  214          //Âá∫ÂºØÁä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  215          void FUNC_OUT_CURVE(){
  216   1          //SteeringPID_State(ON_STRAIGHT);
  217   1          FORWARD_FUNC(0,0);
  218   1          CUR_STATUS = STRAIGHT;
  219   1      }
  220          
  221          //ÂÖ•ÁéØÁä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  222          void FUNC_INTO_CIRCLE(){
  223   1          //SteeringPID_State(ON_TURN);
  224   1        delay_ms(1000);
  225   1          if(DATA[0]>DATA[3]) SteeringControl(40);
  226   1          else SteeringControl(-40);
  227   1          delay_ms(1000);
  228   1          CUR_STATUS = INTO_CIRCLE;
  229   1      }
  230          
  231          //Âú®ÂçÅÂ≠óË∑ØÂè£‰∏≠Áä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  232          void FUNC_CROSS(){
  233   1          FORWARD_FUNC(1,0);
  234   1      }
  235          
  236          //Âá∫ÁéØÁä∂ÊÄÅÂáΩÊï∞ÂÆûÁé∞
  237          void FUNC_OUT_CIRCLE(){
  238   1          //SteeringPID_State(ON_STRAIGHT);
  239   1          FORWARD_FUNC(0,0);
  240   1          delay_ms(1000);
  241   1          if(DATA[0]>DATA[3]) SteeringControl(-40);
  242   1          else SteeringControl(40);
  243   1          delay_ms(1000);
  244   1          CUR_STATUS = STRAIGHT;
  245   1      }
  246          void FUNC_JUNCTION(){
  247   1          FORWARD_FUNC(0,0);
  248   1      }
  249          
*** WARNING C135 IN LINE 117 OF CODE\USER\CONTROL_SYSTEM.c: 'CAR_STATUS_JUDGE': no return value
*** WARNING C135 IN LINE 117 OF CODE\USER\CONTROL_SYSTEM.c: 'CAR_STATUS_JUDGE': no return value

C251 COMPILER V5.60.0,  CONTROL_SYSTEM                                                     18/03/22  21:56:56  PAGE 5   


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       944     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        50     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        21     ------
End of Module Information.


C251 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
